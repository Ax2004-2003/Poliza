<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#003087">
    <title>Sistema Profesional de Pólizas 2025</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Font Awesome + Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

    <style>
        :root{--azul:#003087;--dorado:#D4AF37;--gris:#f8f9fa;--oscuro:#212529}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;padding:15px}
        .container{max-width:1300px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.15);overflow:hidden}
        .header{background:linear-gradient(135deg,var(--azul) 0%,#001f5b 100%);color:white;padding:60px 30px 50px;text-align:center}
        .logo{font-size:5em;font-weight:900;letter-spacing:4px;margin-bottom:20px;text-shadow:0 6px 15px rgba(0,0,0,0.5)}
        .header h1{font-size:3.4em;margin:20px 0 15px;font-weight:700}
        .header p{font-size:1.5em;opacity:0.95;font-weight:300}
        .content{padding:40px}
        .form-section{background:white;padding:35px;border-radius:18px;margin-bottom:35px;box-shadow:0 8px 30px rgba(0,0,0,0.1);border-left:7px solid var(--azul)}
        .form-section h2{color:var(--azul);font-size:2em;margin-bottom:28px;padding-bottom:14px;border-bottom:5px solid var(--dorado);display:flex;align-items:center;gap:15px}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:25px}
        .form-group label{font-weight:600;color:#333;margin-bottom:10px;display:block;font-size:1.05em}
        .form-group input,.form-group select{width:100%;padding:16px 20px;border:2px solid #ddd;border-radius:14px;font-size:1.1em;transition:all .3s}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--azul);box-shadow:0 0 0 6px rgba(0,48,135,0.2)}
        .btn{padding:16px 40px;border:none;border-radius:14px;font-weight:600;cursor:pointer;font-size:1.2em;transition:all .4s;display:inline-flex;align-items:center;gap:12px}
        .btn-primary{background:linear-gradient(135deg,var(--azul),#001f5b);color:white;box-shadow:0 10px 30px rgba(0,48,135,0.5)}
        .btn-primary:hover{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,48,135,0.6)}
        .btn-add{background:#28a745;color:white;padding:14px 30px;font-size:1.1em;border-radius:12px}
        .btn-print{background:#17a2b8;color:white;padding:12px 20px;font-size:1em;border-radius:12px}
        .btn-print:hover{background:#138496}
        .beneficiario-item{background:#f0f8ff;padding:25px;border-radius:14px;margin-bottom:20px;border-left:5px solid var(--dorado);position:relative}
        .btn-remove{position:absolute;top:12px;right:12px;background:#dc3545;color:white;border:none;width:38px;height:38px;border-radius:50%;cursor:pointer;font-size:1.4em}
        .poliza-item{background:white;border:2px solid #eee;border-radius:18px;padding:30px;margin-bottom:30px;box-shadow:0 10px 35px rgba(0,0,0,0.1);transition:all .4s}
        .poliza-item:hover{transform:translateY(-10px);box-shadow:0 20px 50px rgba(0,0,0,0.18)}
        .poliza-header{background:linear-gradient(135deg,var(--azul),#001f5b);color:white;padding:20px 30px;border-radius:14px 14px 0 0;margin:-30px -30px 30px;display:flex;justify-content:space-between;align-items:center;font-size:1.2em}
        .poliza-numero{font-size:2em;font-weight:bold}
        .no-polizas{text-align:center;padding:60px;color:#666;font-size:1.3em}
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">SEGUROS</div>
        <h1>SISTEMA PROFESIONAL<br>DE PÓLIZAS 2025</h1>
        <p>Gestión Corporativa • Certificado ISO 9001 • Tecnología Cloud</p>
    </div>

    <div class="content">
        <form id="polizaForm">
            <div class="form-section">
                <h2>Datos del Asegurado</h2>
                <div class="form-grid">
                    <div class="form-group"><label>Nombre Completo</label><input type="text" id="nombreCliente" required></div>
                    <div class="form-group"><label>RFC</label><input type="text" id="rfc" required></div>
                    <div class="form-group"><label>Teléfono</label><input type="tel" id="telefono" required></div>
                    <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
                    <div class="form-group full-width"><label>Domicilio Completo</label><input type="text" id="direccion" required></div>
                </div>
            </div>

            <div class="form-section">
                <h2>Datos de la Póliza</h2>
                <div class="form-grid">
                    <div class="form-group"><label>Tipo de Seguro</label>
                        <select id="tipoSeguro" required>
                            <option value="auto">Automóvil</option>
                            <option value="gastos">Gastos Médicos Mayores</option>
                            <option value="vida">Seguro de Vida</option>
                            <option value="hogar">Hogar</option>
                            <option value="empresa">Empresarial</option>
                        </select>
                    </div>
                    <div class="form-group"><label>N° Póliza</label><input type="text" id="numeroPoliza" readonly style="font-weight:bold;color:var(--azul);font-size:1.2em;"></div>
                    <div class="form-group"><label>Fecha de Emisión</label><input type="date" id="fechaEmision" required></div>
                    <div class="form-group"><label>Forma de Pago</label>
                        <select id="formaPago" required>
                            <option value="anual">Anual</option>
                            <option value="semestral">Semestral</option>
                            <option value="trimestral">Trimestral</option>
                            <option value="mensual">Mensual</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Prima Neta</label><input type="number" step="0.01" id="primaNeta" required></div>
                    <div class="form-group"><label>IVA (16%)</label><input type="text" id="iva" readonly></div>
                    <div class="form-group"><label>Prima Total</label><input type="text" id="primaTotal" readonly style="font-weight:bold;font-size:1.4em;color:green;"></div>
                </div>
            </div>

            <div class="form-section">
                <h2>Beneficiarios</h2>
                <div id="beneficiariosContainer"></div>
                <button type="button" class="btn btn-add" onclick="agregarBeneficiario()">Agregar Beneficiario</button>
            </div>

            <div style="text-align:center;margin:60px 0;">
                <button type="submit" class="btn btn-primary">EMITIR PÓLIZA OFICIAL</button>
            </div>
        </form>

        <div class="form-section">
            <h2>Pólizas Emitidas Recientemente</h2>
            <div id="polizasContainer"><div class="no-polizas">Cargando pólizas...</div></div>
        </div>
    </div>
</div>

<script type="module">
    // REGISTRO DEL SERVICE WORKER
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(r => console.log('SW registrado'))
                .catch(e => console.log('SW error', e));
        });
    }

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getDatabase, ref, push, onValue } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

    const app = initializeApp({ databaseURL: 'https://polizas-a5513-default-rtdb.firebaseio.com/' });
    const db = getDatabase(app);
    const polizasRef = ref(db, 'polizas_profesional');

    let polizas = [];
    let ultimoNumero = 100000;

    document.getElementById('fechaEmision').valueAsDate = new Date();

    function generarNumeroPoliza() {
        const año = new Date().getFullYear();
        ultimoNumero++;
        return `POL-${año}-${String(ultimoNumero).padStart(6, '0')}`;
    }

    document.getElementById('primaNeta').addEventListener('input', () => {
        const neta = parseFloat(document.getElementById('primaNeta').value) || 0;
        const iva = neta * 0.16;
        const total = neta + iva;
        document.getElementById('iva').value = iva.toFixed(2);
        document.getElementById('primaTotal').value = total.toFixed(2);
    });

    window.agregarBeneficiario = () => {
        const container = document.getElementById('beneficiariosContainer');
        const index = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'beneficiario-item';
        div.innerHTML = `
            <button type="button" class="btn-remove" onclick="this.parentElement.remove()">×</button>
            <div class="form-grid">
                <div class="form-group"><label>Nombre Completo ${index}</label><input type="text" class="benef-nombre" required></div>
                <div class="form-group"><label>Parentesco</label><input type="text" class="benef-parentesco" required></div>
                <div class="form-group"><label>Porcentaje</label><input type="number" class="benef-porcentaje" value="100" min="1" max="100" required></div>
            </div>
        `;
        container.appendChild(div);
    };

    // === FUNCIÓN DE IMPRESIÓN MEJORADA CON MARCA DE AGUA + CLÁUSULAS ===
    window.imprimirPoliza = function(poliza) {
        const printWin = window.open('', '', 'width=1000,height=900');
        const fecha = new Date(poliza.fechaEmision).toLocaleDateString('es-MX', {weekday:'long', year:'numeric', month:'long', day:'numeric'});

        let filas = '';
        poliza.beneficiarios.forEach(b => {
            filas += `<tr>
                <td style="padding:12px;border:1px solid #ccc;">${b.nombre}</td>
                <td style="padding:12px;border:1px solid #ccc;">${b.parentesco}</td>
                <td style="padding:12px;border:1px solid #ccc;text-align:center;">${b.porcentaje}%</td>
            </tr>`;
        });

        printWin.document.write(`
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <title>Póliza ${poliza.numeroPoliza}</title>
            <style>
                body{font-family:Georgia,serif;margin:0;padding:50px;line-height:1.7;color:#1a1a1a;position:relative;background:white}
                body::before{content:"NO CUENTO CON LOS DERECHOS DE AUTOR";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-45deg);font-size:68px;font-weight:900;color:rgba(200,200,200,0.25);letter-spacing:10px;pointer-events:none;z-index:1}
                .header{text-align:center;margin-bottom:50px;position:relative;z-index:2}
                .logo{font-size:5.5em;font-weight:900;color:#003087;letter-spacing:6px;text-shadow:0 6px 15px rgba(0,0,0,0.3)}
                h1{color:#003087;font-size:2.8em;margin:15px 0}
                h2{color:#003087;border-bottom:4px solid #D4AF37;padding-bottom:8px;display:inline-block;margin:20px 0 10px}
                table{width:100%;border-collapse:collapse;margin:30px 0}
                th{background:#003087;color:white;padding:14px}
                td{border:1px solid #ccc;padding:12px}
                .clausulas{background:#f8f9fa;padding:25px;border-radius:12px;border-left:6px solid #D4AF37;margin-top:60px;font-size:0.95em;line-height:1.7}
                .reguladores{text-align:center;margin-top:50px;font-weight:bold;color:#003087}
                .firma{margin-top:80px;text-align:right;font-family:'Dancing Script',cursive;font-size:2em;color:#003087}
                @media print{body{margin:20px;padding:30px} body::before{color:rgba(220,220,220,0.3)!important}}
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">SEGUROS</div>
                <h1>PÓLIZA OFICIAL DE SEGURO</h1>
                <h2>N° ${poliza.numeroPoliza}</h2>
                <p><strong>Fecha de emisión:</strong> ${fecha}</p>
            </div>

            <h2>Datos del Asegurado</h2>
            <p><strong>Nombre:</strong> ${poliza.nombreCliente}<br>
               <strong>RFC:</strong> ${poliza.rfc}<br>
               <strong>Teléfono:</strong> ${poliza.telefono}<br>
               <strong>Email:</strong> ${poliza.email}<br>
               <strong>Domicilio:</strong> ${poliza.direccion}</p>

            <h2>Datos de la Póliza</h2>
            <p><strong>Tipo:</strong> ${poliza.tipoSeguro.toUpperCase().replace('AUTO','AUTOMÓVIL').replace('GASTOS','GASTOS MÉDICOS MAYORES').replace('VIDA','SEGURO DE VIDA').replace('HOGAR','SEGURO DE HOGAR').replace('EMPRESA','SEGURO EMPRESARIAL')}<br>
               <strong>Forma de pago:</strong> ${poliza.formaPago.charAt(0).toUpperCase()+poliza.formaPago.slice(1)}<br>
               <strong>Prima neta:</strong> $${parseFloat(poliza.primaNeta).toLocaleString('es-MX',{minimumFractionDigits:2})}<br>
               <strong>IVA:</strong> $${parseFloat(poliza.iva).toLocaleString('es-MX',{minimumFractionDigits:2})}<br>
               <strong style="font-size:1.8em;color:#28a745;">Prima total: $${parseFloat(poliza.primaTotal).toLocaleString('es-MX',{minimumFractionDigits:2})}</strong></p>

            <h2>Beneficiarios</h2>
            <table><thead><tr><th>Nombre</th><th>Parentesco</th><th>%</th></tr></thead><tbody>${filas}</tbody></table>

            <div class="clausulas">
                <h2>Cláusulas Contractuales</h2>
                <p><strong>1.</strong> La presente póliza se rige por la Ley sobre el Contrato de Seguro.</p>
                <p><strong>2.</strong> Cobertura inicia a las 00:00 hrs del día siguiente al pago.</p>
                <p><strong>3.</strong> Declaración veraz de información bajo protesta de decir verdad.</p>
                <p><strong>4.</strong> Notificación de siniestro en máximo 30 días.</p>
                <p><strong>5.</strong> Exclusiones: dolo, guerra, pandemias declaradas.</p>
                <p><strong>6.</strong> Documento electrónico con validez legal (Art. 89 Código de Comercio).</p>
            </div>

            <div class="reguladores">
                Supervisado por la <strong>Comisión Nacional de Seguros y Fianzas (CNSF)</strong><br>
                <strong>CONDUCEF</strong> 55 5340 0999 • www.condusef.gob.mx<br>
                <strong>PROFECO</strong> 55 5568 8722 • 800 468 8722 • www.profeco.gob.mx
            </div>

            <div style="margin-top:80px;text-align:center;font-size:0.9em;color:#555">
                Sistema Profesional de Pólizas 2025 • Certificado ISO 9001 • Tecnología Cloud<br>
                Documento generado electrónicamente – No requiere firma autógrafa
            </div>
            <div class="firma">Dirección General</div>
        </body>
        </html>`);

        printWin.document.close();
        printWin.focus();
        setTimeout(() => printWin.print(), 800);
    };

    function mostrarPolizas() {
        const container = document.getElementById('polizasContainer');
        if (polizas.length === 0) {
            container.innerHTML = '<div class="no-polizas">No hay pólizas emitidas</div>';
            return;
        }
        const ordenadas = polizas.sort((a,b) => b.fechaEmision.localeCompare(a.fechaEmision));
        container.innerHTML = ordenadas.map(p => `
            <div class="poliza-item">
                <div class="poliza-header">
                    <div class="poliza-numero">${p.numeroPoliza}</div>
                    <div>${new Date(p.fechaEmision).toLocaleDateString('es-MX',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>
                </div>
                <h3 style="margin:15px 0;color:var(--azul);font-size:1.6em;">${p.nombreCliente}</h3>
                <p><strong>Tipo:</strong> ${p.tipoSeguro.toUpperCase()} • <strong>Total:</strong> <span style="color:green;font-size:1.4em;font-weight:bold;">$${parseFloat(p.primaTotal).toLocaleString('es-MX')}</span></p>
                <div style="text-align:right;margin-top:20px;">
                    <button class="btn btn-print" onclick="imprimirPoliza(${JSON.stringify(p).replace(/"/g","&quot;")}">Imprimir</button>
                </div>
            </div>
        `).join('');
    }

    onValue(polizasRef, snap => {
        const data = snap.val();
        if (data) {
            polizas = Object.entries(data).map(([id,val])=>({id,...val}));
            const nums = polizas.map(p => parseInt((p.numeroPoliza||'').match(/\d{6}$/)?.[0] || 0));
            ultimoNumero = nums.length ? Math.max(...nums) : 100000;
        } else polizas = [];
        document.getElementById('numeroPoliza').value = generarNumeroPoliza();
        mostrarPolizas();
    });

    document.getElementById('polizaForm').onsubmit = async e => {
        e.preventDefault();
        const beneficiarios = Array.from(document.querySelectorAll('.beneficiario-item')).map(item => ({
            nombre: item.querySelector('.benef-nombre').value.trim(),
            parentesco: item.querySelector('.benef-parentesco').value.trim(),
            porcentaje: item.querySelector('.benef-porcentaje').value
        })).filter(b => b.nombre);

        const poliza = {
            numeroPoliza: document.getElementById('numeroPoliza').value,
            fechaEmision: document.getElementById('fechaEmision').value,
            nombreCliente: document.getElementById('nombreCliente').value.trim(),
            rfc: document.getElementById('rfc').value.trim(),
            telefono: document.getElementById('telefono').value.trim(),
            email: document.getElementById('email').value.trim(),
            direccion: document.getElementById('direccion').value.trim(),
            tipoSeguro: document.getElementById('tipoSeguro').value,
            primaNeta: parseFloat(document.getElementById('primaNeta').value),
            iva: parseFloat(document.getElementById('iva').value),
            primaTotal: parseFloat(document.getElementById('primaTotal').value),
            formaPago: document.getElementById('formaPago').value,
            beneficiarios
        };

        await push(polizasRef, poliza);
        document.getElementById('numeroPoliza').value = generarNumeroPoliza();
        e.target.reset();
        document.getElementById('beneficiariosContainer').innerHTML = '';
        agregarBeneficiario();
        alert('PÓLIZA EMITIDA CORRECTAMENTE');
    };

    agregarBeneficiario(); // uno al cargar
</script>
</body>
</html>
